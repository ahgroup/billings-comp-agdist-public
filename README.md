

<!-- README.md is generated from README.qmd. Please edit that file -->

# CompAgDist (CAD)

<!-- badges: start -->

<!-- badges: end -->

This project, tentatively titled “Impact of antigenic distance on the
heterologous immune response to seasonal influenza vaccine in an elderly
human cohort” focuses on analyzing the UGAFluVac dataset. This is a
followup to [this research
project](https://github.com/ahgroup/SD-HD-flu-vaccine), which analyzed
heterologous immunity separately for each vaccine strain that was
analyzed in the UGAFluVac data. For this project, we plan to build on
our previous work on antigenic distances, and replace discrete
strain-specific effects with the continuous effect of antigenic
distance.

We will control for confounding in a causal analysis framework and used
bayesian multilevel modeling to estimate the impact of antigenic
distance on vaccine outcomes, specifically focusing on comparing
individuals who received HD and SD vaccines.

## Software requirements

- R version 4.4.1 (2024-06-14 ucrt)
- Quarto version 1.6.40
- Cmdstan version 2.36.0
- Several R packages which are listed in `renv.lock` and in the system
  output shown below.
- The listed dependencies for all of those things
- Note that the following packages *must* be built from source if you
  run this script on UGA’s sapelo2 cluster. The project `runner.R`
  script called by `job.sh` should? take care of this. (The R version on
  the cluster does not provide the necessary internal LAPACK libraries
  but the compiler can link to the correct LAPACK setup on the cluster.
  For some reason there appears to be no option to force `renv` to
  compile specific (or even all) packages from source during
  `renv::restore()`. I tried setting the option `pkgType` which `renv`
  claims to support, but actually does not seem to do anything.)
  - `RcppArmadillo@14.2.2-1`
  - `mvtnorm@1.3-2`
  - `nloptr@2.1.1`
  - `igraph@2.1.2`
- On Windows, you’ll need Rtools 44 (LINK HERE). If you’re on MacOS or
  any kind of Linux or any other OS, we can’t guarantee that our code
  will work, and you’ll need to make sure you have any necessary system
  dependencies.

## Running the project

To run this project on a Slurm cluster, you should log on to your Slurm
cluster account. Then you can clone this project from GitHub however you
want (I recommend using `ssh` but you don’t have to).

For other handelgroup members, I recommend the following steps.

1.  Log into the cluster using `ssh your_my_id@sapelo2.gacrc.uga.edu`.
2.  Set up an ssh key in your home directory following [GitHub’s
    directions](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent)
    (you can just use all the default settings).
3.  Clone the git repo into your home directory (or scratch, our jobs
    are small enough that it really shouldn’t matter although scratch is
    technically preferred since we’ll be running code and I/O stuff, if
    your project will generate over 200GB of files you MUST use
    scratch).
4.  Start an interactive job, request at least 10 GB of memory (you can
    cancel it and get more if you need to).
5.  In the interactive job, load R and start an interactive R session.
    Install all of your dependencies. Note that anything that references
    LAPACK will need to be built from source which renv might mess up if
    you just run `renv::restore()`. Also make sure you install cmdstanr
    for this project.
6.  Now you can run the actual cluster job, that will be run like this:

`sbatch --mail-user=email@email.com job.sh`

Of course you should put your email in there, not a fake one. You can
hardcode your email in the `job.sh` script but you probably shouldn’t
since this code will be public and people might (though unlikely) run
your code in the future without changing anything and you will get
emails.

## Repository structure and content

The template comes with a folder structure and example files to
illustrative the kinds of content you would place in the different
folders. The following is a brief description of the contents. See the
`readme` files in each folder for more details.

- The `assets` folder contains static assets like manually generated
  schematics/diagrams, bibtex files, csl style files, PDFs of
  references, and other such content. These assets are not code-based
  and are not generated by code. Basically add anything that’s you want
  to be part of this repo but that doesn’t fit into the other
  categories.

- All code goes into the `code` folder and subfolders. Currently, there
  are 3 sub-folders that do different parts of an analysis. You can
  re-organize such that it makes most sense for your project. The
  folders contain files that do some data cleaning and analysis to
  illustrate the overall setup and workflow. See the readme files in
  those folders for details.

- All data goes into the `data` folder and subfolders. Currently, there
  are 2 sub-folders that contain different versions of a simple example
  data set. You can re-organize such that it makes most sense for your
  project.

- The `products` folder and its subfolders contains deliverables, such
  as manuscript/report, the supplement, slide decks, posters, Shiny web
  apps, etc. Those should generally be made with Quarto/R. As needed,
  other formats can be used. There is an example manuscript and and
  example slide deck.

  - The `manuscript` subfolder contains a template for a report written
    as Quarto file. If you access this repository as part of [my Modern
    Applied Data Science
    course](https://andreashandel.github.io/MADAcourse/), the sections
    are guides for your project. If you found your way to this
    repository outside the course, you might only be interested in
    seeing how the file pulls in results and references and generates a
    word document as output, without paying attention to the detailed
    structure. There is also a sub-folder containing an example template
    for a supplementary material file.
  - The `slides` subfolder contains a basic example of slides made with
    Quarto.

- The `results` folder contains automatically/code generated output.
  This includes figures, tables saved as serialized R data (`.Rds`)
  files, computed values and other outputs. All content in these folders
  should be automatically generated by code. Manually generated results
  should be avoided as much as possible. If absolutely necessary, they
  go into the `assets` folder.

- There are multiple special files in the repo.

  - `readme.md`: this file contains instructions or details about the
    folder it is located in. You are reading the project-level
    `README.md` file right now. There is a `readme` in almost every
    folder.
  - `data-analysis-template.Rproj` is a file that tells RStudio that
    this is the main folder for a project. Rename if you want.
  - a few “hidden” files and folders (they start with a `.` and
    depending on how your OS is configured, you might not see them).
    Those are for R/RStudio and Git/GitHub and you can ignore them.

## Endpoint files

``` r
print_paths <- function(paths) {paste0('`', paths, '`', collapse = "; ")}

# Make sure all "endpoint" files are loadable.
# Mostly cause it makes the pipeline plot look nice.
# Manuscript and supplement and metadata
ms_files <- targets::tar_read("manuscript")
sp_files <- targets::tar_read("supplement")
md_files <- targets::tar_read("zipped_metadata_submission")
# Data files
reporting_data_files <- targets::tar_read("civics_reporting_data_files")
model_data_files <- targets::tar_read("model_data_files")
# Model files
model_metadata <- targets::tar_read("model_metadata_file")
prior_fits <- targets::tar_read("brms_prior_fit_files")
posterior_fits <- targets::tar_read("brms_posterior_fit_files")
```

In addition to our figures and tables for the manuscript, our pipeline
produces multiple output files which could be suitable for further
examination or analysis. These are included in our repo as the following
files.

- Main manuscript: `products/manuscript/Manuscript.docx`;
  `products/manuscript/Manuscript.qmd`.
- Supplementary material: `products/manuscript/Supplement.docx`;
  `products/manuscript/Supplement.qmd`.
- Auxiliary files for generating manuscript and supplement:
  `assets/package-refs.bib`; `assets/refs.bib`; `assets/vancouver.csl`;
  `assets/word-template.docx`.
- Zipped NIH CIVICs metadata files:
  `F:/research/billings-comp-agdist-project/assets/CIVICs-metadata-submission.zip`.
- NIH CIVICs-standard formatted dataset:
  `F:/research/billings-comp-agdist-project/data/processed/reporting-data.Rds`;
  `F:/research/billings-comp-agdist-project/data/processed/reporting-data.csv`.
- Transformed dataset for modeling:
  `F:/research/billings-comp-agdist-project/data/processed/model-data.Rds`;
  `F:/research/billings-comp-agdist-project/data/processed/model-data.csv`.
- Model metadata for ordering the model fits:
  `F:/research/billings-comp-agdist-project/results/output/model-metadata.Rds`
- Prior samples from models (directory):
  `/scratch/wb12984/billings-comp-agdist-project/results/large-files/brms-fits/prior`.
- Posterior sampels from models (directory):
  `/scratch/wb12984/billings-comp-agdist-project/results/large-files/brms-fits/posterior`.

## License

All of the code we wrote is distributed under the [Affero GNU GPL
v3.0](LICENSE.md). Any code that was not written by us has been
attributed and is released under the conditions of its own license. Any
text and images we created are licensed under the [Creative Commons 4.0
BY-NC-SA international
license](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en).

## TODO

- [x] Finish targetization
  - [x] targetize supplement results
  - [x] targetize model comparison
  - [x] targetize model results
- [x] typo in table demographics
- [x] Make sure model description in manuscript matches final models
- [x] Decide whether and when to mention UGA 2016 starting in Winter
- [x] Change UGA labelling to GA throughout (decided not to)
- [x] IRR to main text
- [x] Correlations calculations and table for supplement
- [x] Table of model explanations
- [x] Move ELPD table to before LMM table
- [x] CIVICs reporting data
- [x] Cleanup unnecessary files and targets
  - [x] Remove gap sd bootstrap file target
  - [x] Remove ICC summary file target
  - [x] Remove old files to aux
  - [x] Make sure all results are generated by pipeline
- [x] Finish supplement skeleton
  - [x] Other metrics analysis
  - [x] WAIC analysis (not doing this)
  - [x] Vaccine-specific predictions analysis
  - [x] Misc todos
  - [x] Methods writing
  - [x] update models in supplement
- [ ] Update main text methods
- [ ] Rewrites after final models run
  - [ ] Consider revising small/low correlation language
  - [ ] Simplify “predictions made by ….” paragraph
    - [ ] explain high and low slopes
    - [x] **directly compare ELPDs across the four models**
  - [ ] Discussion revisions
- [ ] reproducibility writing
  - [ ] create public repo
  - [ ] write reproducibility instructions
  - [ ] archive on zenodo
  - [ ] add zenodo and GH text in manuscript
  - [ ] Finish README
- [ ] Final review
  - [ ] Change B lineage mentions to / notation (REVIEW ALL
    PLOTS/TABLES)
  - [ ] Review all plots tables for order of metrics
  - [ ] Add supplement chapters and stuff to MS

## Session info

    #> R version 4.4.1 (2024-06-14 ucrt)
    #> Platform: x86_64-w64-mingw32/x64
    #> Running under: Windows 10 x64 (build 19045)
    #> 
    #> Matrix products: default
    #> 
    #> 
    #> locale:
    #> [1] LC_COLLATE=English_United States.utf8 
    #> [2] LC_CTYPE=English_United States.utf8   
    #> [3] LC_MONETARY=English_United States.utf8
    #> [4] LC_NUMERIC=C                          
    #> [5] LC_TIME=English_United States.utf8    
    #> 
    #> time zone: America/New_York
    #> tzcode source: internal
    #> 
    #> attached base packages:
    #> [1] tools     stats     graphics  grDevices datasets  utils     methods  
    #> [8] base     
    #> 
    #> other attached packages:
    #>  [1] zip_2.3.1              visNetwork_2.1.2       tidyselect_1.2.1      
    #>  [4] tidyr_1.3.1            tidybayes_3.0.7        tibble_3.2.1          
    #>  [7] targets_1.11.1         tarchetypes_0.13.0     striprtf_0.6.0        
    #> [10] stringr_1.5.1          softbib_0.0.2          rstudioapi_0.17.1     
    #> [13] rstan_2.32.6           StanHeaders_2.32.10    rlang_1.1.4           
    #> [16] renv_1.1.4             readr_2.1.5            quarto_1.4.4          
    #> [19] purrr_1.0.2            posterior_1.6.0        patchwork_1.3.0       
    #> [22] parallelly_1.40.1      mime_0.12              MASS_7.3-61           
    #> [25] markdown_1.13          marginaleffects_0.25.1 loo_2.8.0             
    #> [28] knitr_1.49             Hmisc_5.2-3            hgp_0.0.10            
    #> [31] here_1.0.1             gtsummary_2.0.4        ggdist_3.3.2          
    #> [34] ggdag_0.2.13           GGally_2.2.1           ggplot2_3.5.1         
    #> [37] gamm4_0.2-6            mgcv_1.9-1             nlme_3.1-166          
    #> [40] lme4_1.1-35.5          Matrix_1.7-0           future.apply_1.11.3   
    #> [43] future_1.34.0          forcats_1.0.0          flextable_0.9.7       
    #> [46] dplyr_1.1.4            dagitty_0.3-4          crew.cluster_0.3.4    
    #> [49] crew_1.1.0             cmdstanr_0.8.1         broom_1.0.7           
    #> [52] brms_2.22.0            Rcpp_1.0.14            bayesboot_0.2.3       
    #> [55] devtools_2.4.5         usethis_3.1.0          yaml_2.3.10           
    #> [58] rmarkdown_2.29        
    #> 
    #> loaded via a namespace (and not attached):
    #>   [1] svUnit_1.0.6            splines_4.4.1           later_1.4.1            
    #>   [4] rpart_4.1.23            lifecycle_1.0.4         rprojroot_2.0.4        
    #>   [7] globals_0.16.3          processx_3.8.4          lattice_0.22-6         
    #>  [10] backports_1.5.0         magrittr_2.0.3          remotes_2.5.0          
    #>  [13] httpuv_1.6.15           askpass_1.2.1           sessioninfo_1.2.2      
    #>  [16] pkgbuild_1.4.5          minqa_1.2.8             RColorBrewer_1.1-3     
    #>  [19] abind_1.4-8             pkgload_1.4.0           nnet_7.3-19            
    #>  [22] tensorA_0.36.2.1        gdtools_0.4.1           inline_0.3.20          
    #>  [25] listenv_0.9.1           bridgesampling_1.1-2    codetools_0.2-20       
    #>  [28] xml2_1.3.6              farver_2.1.2            bayesplot_1.11.1       
    #>  [31] stats4_4.4.1            matrixStats_1.4.1       base64enc_0.1-3        
    #>  [34] jsonlite_1.8.9          ellipsis_0.3.2          tidygraph_1.3.1        
    #>  [37] Formula_1.2-5           systemfonts_1.1.0       ragg_1.3.3             
    #>  [40] glue_1.8.0              gridExtra_2.3           xfun_0.49              
    #>  [43] distributional_0.5.0    withr_3.0.2             fastmap_1.2.0          
    #>  [46] boot_1.3-30             fansi_1.0.6             openssl_2.2.2          
    #>  [49] callr_3.7.6             digest_0.6.37           secretbase_1.0.5       
    #>  [52] R6_2.5.1                textshaping_0.4.1       colorspace_2.1-1       
    #>  [55] utf8_1.2.4              generics_0.1.3          fontLiberation_0.1.0   
    #>  [58] data.table_1.16.4       prettyunits_1.2.0       htmlwidgets_1.6.4      
    #>  [61] ggstats_0.7.0           pkgconfig_2.0.3         gtable_0.3.6           
    #>  [64] htmltools_0.5.8.1       fontBitstreamVera_0.1.1 profvis_0.4.0          
    #>  [67] base64url_1.4           scales_1.3.0            nanonext_1.5.2         
    #>  [70] tzdb_0.4.0              uuid_1.2-1              coda_0.19-4.1          
    #>  [73] checkmate_2.3.2         curl_6.0.1              nloptr_2.1.1           
    #>  [76] cachem_1.1.0            parallel_4.4.1          miniUI_0.1.1.1         
    #>  [79] foreign_0.8-86          pillar_1.9.0            grid_4.4.1             
    #>  [82] vctrs_0.6.5             urlchecker_1.0.1        promises_1.3.2         
    #>  [85] arrayhelpers_1.1-0      xtable_1.8-4            cluster_2.1.6          
    #>  [88] htmlTable_2.4.3         evaluate_1.0.1          mvtnorm_1.3-2          
    #>  [91] cli_3.6.3               compiler_4.4.1          rstantools_2.4.0       
    #>  [94] ps_1.8.1                plyr_1.8.9              fs_1.6.5               
    #>  [97] stringi_1.8.4           QuickJSR_1.4.0          getip_0.1-4            
    #> [100] munsell_0.5.1           Brobdingnag_1.2-9       V8_6.0.0               
    #> [103] fontquiver_0.2.1        hms_1.1.3               shiny_1.9.1            
    #> [106] mirai_2.2.0             igraph_2.1.2            memoise_2.0.1          
    #> [109] RcppParallel_5.1.10     officer_0.6.7

<!-- END OF FILE -->
